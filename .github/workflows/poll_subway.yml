name: Poll MTA Subway (Penn) → Drive

on:
  schedule:
    # Hourly baseline (UTC)
    - cron: "5 * * * *"
    # AM peak (7–9 ET)
    - cron: "20,35,50 11-13 * * *"
    # PM peak (4–6 ET)
    - cron: "20,35,50 20-22 * * *"
  workflow_dispatch: {}

concurrency:
  group: poll-subway-append
  cancel-in-progress: true

jobs:
  poll:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    # Common env for all steps
    env:
      PYTHONUNBUFFERED: "1"
      PYTHONFAULTHANDLER: "1"

      # GDrive / polling config
      GDRIVE_REMOTE_NAME: ${{ secrets.GDRIVE_REMOTE_NAME }}
      GDRIVE_DIR_SUBWAY: ${{ vars.GDRIVE_DIR_SUBWAY || 'penn-station/subway' }}
      SUBWAY_MASTER_NAME: ${{ vars.SUBWAY_MASTER_NAME || 'subway_penn_master.csv' }}
      SUBWAY_STOP_IDS: ${{ secrets.SUBWAY_STOP_IDS }}   # e.g., "127N,127S,A34N,A34S"
      MTA_API_KEY: ${{ secrets.MTA_API_KEY }}
      SUBWAY_FEEDS_JSON: >-
        ["https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs",
         "https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-ace"]

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python with pip cache
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          # This file is optional; if you later create a
          # pollers/requirements-subway.txt, caching gets even better.
          cache-dependency-path: |
            pollers/requirements-subway.txt

      # 3. Install Python dependencies (with protobuf pinned < 6)
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            "pandas==2.2.2" \
            "numpy==2.0.2" \
            "requests>=2.31,<3" \
            "protobuf>=4.23,<6" \
            "gtfs-realtime-bindings==1.0.0"

      # 4. Install rclone
      - name: Install rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          rclone version

      # 5. Configure rclone from base64-encoded config in secrets
      - name: Configure rclone
        env:
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF_B64 }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF_B64" | base64 -d > ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf

      # 6. Ensure local + remote directories exist
      - name: Ensure data directories
        run: |
          mkdir -p data/subway
          # Ensure remote dir exists (ignore if it already does)
          rclone mkdir "${GDRIVE_REMOTE_NAME}:${GDRIVE_DIR_SUBWAY}/raw" || true

      # 7. Run the subway poller
      - name: Poll MTA Subway and append to master
        run: |
          echo "SUBWAY_STOP_IDS: ${SUBWAY_STOP_IDS}"
          echo "GDRIVE_DIR_SUBWAY: ${GDRIVE_DIR_SUBWAY}"
          echo "SUBWAY_MASTER_NAME: ${SUBWAY_MASTER_NAME}"
          python3 pollers/poll_subway.py

      # 8. On failure, capture artifacts (raw data / logs) for debugging
      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: poll-subway-debug
          path: |
            data/subway
          if-no-files-found: ignore
